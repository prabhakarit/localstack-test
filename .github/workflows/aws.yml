name: aws-action
on: push
jobs:
  build:
      runs-on: ubuntu-latest
      steps:
      - name: Setup AWS-CLI-local
        #env:
          # for actuals read from secrets
          # LOCALSTACK_API_KEY: 3KxvpMbLld
        run: |
          # Upgrading python to 3.9
          sudo apt install python3.9
          sudo apt install python3-pip
          # Fix for pyOpenSSL error, fixing version for compatibility
          pip install --ignore-installed pyOpenSSL==22.0.0
      - name: Checkout codebase
        uses: actions/checkout@v3
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v1
        with:
          terraform_version: 1.2.5
#       - name: Configure AWS Credentials
#         uses: aws-actions/configure-aws-credentials@v1
#         with:
#           audience: localhost:4566
#           aws-region: us-east-1
#           # for actuals read from secrets
#           aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
#           aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      - name: Plan and apply changes
        run: |
          export TF_CLI_ARGS_plan="-compact-warnings"
          export TF_CLI_ARGS_apply="-compact-warnings"
          terraform init
          terraform validate
          terraform plan -input=false -no-color  
          terraform apply -auto-approve
      - name: Validate terraform apply
        run: |
          echo "Testing Terraform changes"
          echo "List buckets"
          awslocal s3 ls
          echo "Test upload"
          touch testFile.txt
          echo "hello world from Prabhakar using Terraform" >> testFile.txt
          awslocal s3 cp testFile.txt s3://my-bucket
          echo "View objects on S3"
          awslocal s3api list-objects --bucket my-bucket
          echo "Download and view content of object"
          awslocal s3api get-object --bucket my-bucket --key testFile.txt output.txt
          cat output.txt
          echo "delete object in bucket"
          awslocal s3api delete-object --bucket my-bucket --key testFile.txt
      - name: Terraform destroy resource
        run: |
          terraform destroy -auto-approve
